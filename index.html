<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #f0f8ff, #e6f7ff); color: #333; padding: 30px; }
    h1 { color: #007acc; text-shadow: 1px 1px 2px #ccc; margin-bottom: 5px; }
    .author { color: #888; font-size: 0.8em; margin-top: 0; margin-bottom: 20px; }
    input[type="text"], input[type="password"], select { padding: 10px; margin: 10px 0; border: 2px solid #007acc; border-radius: 5px; width: 300px; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; background-color: #007acc; color: white; cursor: pointer; box-shadow: 1px 1px 5px #aaa; transition: background-color 0.3s ease; }
    button:hover { background-color: #005f99; }
    .hidden { display: none; }
    #results, #adminPanel, #adminLogin { margin-top: 20px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px #ccc; overflow-x: auto; }
    table { min-width: 800px; width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #e0f0ff; font-weight: bold; cursor: pointer; position: relative; }
    th:hover { background-color: #c9e5ff; }
    th::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; opacity: 0.5; }
    th.asc::after { content: '↑'; opacity: 1; }
    th.desc::after { content: '↓'; opacity: 1; }
    #timestamp { margin-top: 30px; font-style: italic; color: #555; }
    .error { color: red; margin-top: 5px; }
    /* Improved highlight colors - brighter but text remains visible */
    .highlight-0 { background-color: #FFFF00; font-weight: bold; }  /* Bright Yellow */
    .highlight-1 { background-color: #00FF00; font-weight: bold; }  /* Bright Green */
    .highlight-2 { background-color: #00FFFF; font-weight: bold; }  /* Bright Cyan */
    .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; }  /* Bright Magenta */
    .highlight-4 { background-color: #FF8000; font-weight: bold; }  /* Bright Orange */
    .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }  /* Bright Pink */
    .file-selector { margin: 15px 0; }
    .file-selector label { font-weight: bold; display: block; margin-bottom: 5px; }
    .file-nickname { display: flex; align-items: center; margin-bottom: 10px; }
    .file-nickname input { margin-right: 10px; }
    .admin-section { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 8px; }
    .admin-tools { margin-top: 20px; padding: 15px; background-color: #fff0f0; border-radius: 8px; }
    .password-prompt { margin-top: 15px; padding: 10px; background-color: #fff9e6; border-radius: 5px; border: 1px solid #ffcc00; }
    .admin-header { text-decoration: underline; text-underline-offset: 5px; margin-bottom: 15px; }
    .selection-controls { margin: 10px 0; }
    .log-row { transition: background-color 0.2s; }
    .log-row:hover { background-color: #f5f5f5; }
    .selected { background-color: #e6f7ff !important; }
    .table-container { position: relative; }
    #selectAllLogs { margin-right: 10px; }
    .selected-files { margin-top: 10px; font-style: italic; color: #555; }
    .search-options { display: flex; align-items: center; margin: 10px 0; }
    .search-options > div { margin-right: 20px; }
    .search-options label { margin-left: 5px; }

    /* New styles for column customization */
    .column-customizer {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f0f0f0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    .column-customizer label {
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
    }
    .column-customizer button {
        margin-left: auto;
    }
    .print-only {
        display: none;
    }
    @media print {
        body > *:not(.print-only) {
            display: none;
        }
        .print-only {
            display: block;
        }
        table, tr, th, td {
            border: 1px solid black !important;
        }
        
    }
  </style>
</head>
<body>
  <h1>📊 Excel Search Dashboard</h1>
  <p class="author">by Shakeel</p>
  
  <!-- User Authentication Section -->
  <div id="userAuth" class="hidden">
    <h3>👤 Please Enter Your Name to Continue</h3>
    <input type="text" id="userName" placeholder="Enter your name (letters only)..." />
    <div id="nameError" class="error hidden">Please enter a valid name (letters only, no numbers or special characters)</div>
    <button onclick="setUserName()">Continue</button>
    <button onclick="toggleAdminLogin()">Admin Mode</button>
  </div>
  
  <div id="mainContent">
    <p id="timestamp">Page loaded: <span id="lastUpdated"></span></p>
    
    <!-- File Selection Section -->
    <div id="fileSelector" class="file-selector">
      <label for="fileSelect">📁 Select Excel Files to Search:</label>
      <select id="fileSelect">
        <option value="" selected disabled>-- Select files to search --</option>
        <option value="all">All Files</option>
        <!-- Files will be populated here -->
      </select>
      <p id="selectedFiles" class="selected-files">No files selected</p>
    </div>
    
    <input type="text" id="searchInput" placeholder="Search keywords separated by commas..." />
    
    <!-- New search options -->
    <div class="search-options">
        <div>
            <input type="checkbox" id="columnWiseSearchToggle" onchange="toggleColumnSearch()">
            <label for="columnWiseSearchToggle">Column-wise search</label>
        </div>
        <div>
            <label for="searchTypeSelect">Search type:</label>
            <select id="searchTypeSelect">
                <option value="contains">Contains</option>
                <option value="exact">Exact</option>
                <option value="startsWith">Starts with</option>
                <option value="endsWith">Ends with</option>
            </select>
        </div>
        <div id="columnSelector" class="hidden">
            <label for="searchColumnSelect">Search column:</label>
            <select id="searchColumnSelect"></select>
        </div>
    </div>

    <button onclick="performSearch()">Search</button>
    <button onclick="toggleAdminLogin()">Admin Mode</button>
    <button onclick="logout()" style="background-color: #ff6b6b;">Logout</button>

    <div id="results" class="hidden">
      <p><strong>Excel Sources Loaded:</strong> <span id="excelUploadDate">Fetching...</span></p>
      <p>Total Matches: <span id="totalMatches">0</span></p>
      <p id="perTermMatches"></p>
      <h3>🔎 Search Results</h3>
      
      <!-- Moved export buttons above the results table -->
      <div id="exportButtons" style="margin-top: 15px;">
        <button onclick="exportToExcel()">📊 Export to Excel</button>
        <button onclick="exportToCsv()">📝 Export to CSV</button>
        <button onclick="printResults()">🖨️ Download as PDF</button>
        <button onclick="showColumnCustomizer()">⚙️ Customize Columns</button>
      </div>

      <div id="columnCustomizer" class="column-customizer hidden">
        <p><strong>Select columns to display:</strong></p>
        <div id="columnCheckboxes"></div>
        <button onclick="applyColumnVisibility()">Apply</button>
        <button onclick="showAllColumns()">Show All</button>
      </div>
      
      <div id="resultText"></div>
    </div>
  </div>

  <!-- Admin Login - Now appears alongside content -->
  <div id="adminLogin" class="hidden">
    <h3>🔐 Admin Login</h3>
    <input type="text" id="adminUser" placeholder="Username" /><br>
    <input type="password" id="adminPass" placeholder="Password" /><br>
    <button onclick="checkAdminLogin()">Login</button>
    <button onclick="toggleAdminLogin()" style="background-color: #ff6b6b;">Cancel</button>
  </div>

  <!-- Admin Panel - Now appears alongside content -->
  <div id="adminPanel" class="hidden">
    <h3 class="admin-header">📋 Admin Panel - User Activity Logs</h3>
    <button onclick="hideAdminPanel()" style="background-color: #ff6b6b; margin-bottom: 15px;">Close Admin Panel</button>
    
    <div class="admin-tools">
      <h3 class="admin-header">🛠️ Admin Tools</h3>
      <button onclick="exportUserLogs()">📝 Export Logs as Text</button>
      <button onclick="showDeleteConfirmation()" style="background-color: #ff6b6b;">🗑️ Delete Selected Logs</button>
      
      <div class="selection-controls">
        <label><input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this.checked)"> Select All</label>
        <button onclick="deleteSelectedLogs()" style="background-color: #ff6b6b; margin-left: 10px;">Delete Selected</button>
      </div>
      
      <div id="deleteConfirmation" class="password-prompt hidden">
        <h4>Confirm Deletion</h4>
        <p>This will permanently delete all selected user logs. This action cannot be undone.</p>
        <input type="password" id="deletePassword" placeholder="Enter admin password to confirm" />
        <button onclick="deleteAllLogs()" style="background-color: #ff6b6b;">Confirm Delete All</button>
        <button onclick="hideDeleteConfirmation()">Cancel</button>
      </div>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Select</th>
            <th>User Name</th>
            <th>Login Time</th>
            <th>Logout Time</th>
            <th>Duration</th>
            <th>Search Count</th>
            <th>Last Search</th>
          </tr>
        </thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>

    <!-- Admin File Management Section -->
    <div class="admin-section">
      <h3 class="admin-header">📁 File Management - Set Nicknames</h3>
      <div id="fileNicknameManager">
        <!-- File nickname inputs will be populated here -->
      </div>
      <button onclick="saveFileNicknames()">💾 Save Nicknames</button>
      <button onclick="resetFileNicknames()" style="background-color: #ff6b6b;">🔄 Reset to Default</button>
    </div>
  </div>
  
  <!-- Print-only view -->
  <div class="print-only">
    <h2>Search Results</h2>
    <p><strong>Query:</strong> <span id="printQuery"></span></p>
    <p><strong>Total Matches:</strong> <span id="printMatches"></span></p>
    <div id="printTableContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // Global variables
    let excelData = [];
    let availableFiles = [];
    let fileNicknames = {};
    let searchLogs = [];
    let userSessions = [];
    let currentResults = [];
    let currentUserName = "";
    let currentUserLoginTime = null;
    let userSearchCount = 0;
    let userLastSearch = "";
    const highlightColors = ["highlight-0", "highlight-1", "highlight-2", "highlight-3", "highlight-4", "highlight-5"];
    let sortColumn = null;
    let sortDirection = 'asc';
    let selectedLogs = new Set();
    let currentHeaders = [];
    let visibleColumns = [];

    // Load file nicknames from localStorage or initialize empty object
    function loadFileNicknames() {
      const savedNicknames = localStorage.getItem('fileNicknames');
      if (savedNicknames) {
        fileNicknames = JSON.parse(savedNicknames);
      } else {
        fileNicknames = {};
      }
    }

    // Save file nicknames to localStorage
    function saveFileNicknames() {
      // Collect all nickname inputs
      const nicknameInputs = document.querySelectorAll('.nickname-input');
      nicknameInputs.forEach(input => {
        const filename = input.dataset.filename;
        const nickname = input.value.trim();
        if (nickname) {
          fileNicknames[filename] = nickname;
        } else {
          // If nickname is empty, remove it from the object
          delete fileNicknames[filename];
        }
      });
      
      // Save to localStorage
      localStorage.setItem('fileNicknames', JSON.stringify(fileNicknames));
      showCustomAlert("File nicknames saved successfully!");
      
      // Update the file dropdown
      updateFileDropdown();
    }

    // Reset file nicknames to default (empty)
    function resetFileNicknames() {
      showCustomConfirm("Are you sure you want to reset all file nicknames to their default names?", () => {
        fileNicknames = {};
        localStorage.removeItem('fileNicknames');
        renderFileNicknameManager();
        updateFileDropdown();
        showCustomAlert("File nicknames have been reset to default.");
      });
    }

    // Update the file selection dropdown with nicknames
    function updateFileDropdown() {
      const fileSelect = document.getElementById("fileSelect");
      
      // Clear existing options except the first two
      while (fileSelect.options.length > 2) {
        fileSelect.remove(2);
      }
      
      // Add files to dropdown with nicknames if available
      availableFiles.forEach(file => {
        const option = document.createElement("option");
        option.value = file.name;
        
        // Use nickname if available, otherwise use filename
        const displayName = fileNicknames[file.name] || file.name;
        option.textContent = displayName;
        
        fileSelect.appendChild(option);
      });
    }

    // Update selected files display
    function updateSelectedFilesDisplay() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedFilesElement = document.getElementById("selectedFiles");
      
      if (fileSelect.value === "all") {
        selectedFilesElement.textContent = "All files selected";
      } else if (fileSelect.value) {
        const displayName = fileNicknames[fileSelect.value] || fileSelect.value;
        selectedFilesElement.textContent = `Selected: ${displayName}`;
      } else {
        selectedFilesElement.textContent = "No files selected";
      }
      
      // Automatically load the selected file
      loadSelectedExcelFiles();
    }

    // Render the file nickname manager in the admin panel
    function renderFileNicknameManager() {
      const manager = document.getElementById("fileNicknameManager");
      manager.innerHTML = "";
      
      if (availableFiles.length === 0) {
        manager.innerHTML = "<p>No files available to manage.</p>";
        return;
      }
      
      availableFiles.forEach(file => {
        const div = document.createElement("div");
        div.className = "file-nickname";
        
        const label = document.createElement("label");
        label.textContent = file.name + ":";
        label.style.minWidth = "150px";
        
        const input = document.createElement("input");
        input.type = "text";
        input.className = "nickname-input";
        input.dataset.filename = file.name;
        input.value = fileNicknames[file.name] || "";
        input.placeholder = "Enter nickname for " + file.name;
        
        div.appendChild(label);
        div.appendChild(input);
        manager.appendChild(div);
      });
    }

    // Show delete confirmation dialog
    function showDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.remove('hidden');
      document.getElementById('deletePassword').focus();
    }

    // Hide delete confirmation dialog
    function hideDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.add('hidden');
      document.getElementById('deletePassword').value = '';
    }

    // Delete all logs after password confirmation
    function deleteAllLogs() {
      const password = document.getElementById('deletePassword').value.trim();
      
      if (password !== "9332") {
        showCustomAlert("Incorrect admin password. Deletion cancelled.");
        hideDeleteConfirmation();
        return;
      }
      
      // Clear all logs
      userSessions = [];
      searchLogs = [];
      selectedLogs.clear();
      
      // Update UI
      loadLogs();
      hideDeleteConfirmation();
      showCustomAlert("All logs have been deleted successfully.");
    }

    // Toggle selection of all logs
    function toggleSelectAllLogs(selectAll) {
      const checkboxes = document.querySelectorAll('.log-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const index = parseInt(checkbox.dataset.index);
        if (selectAll) {
          selectedLogs.add(index);
        } else {
          selectedLogs.delete(index);
        }
      });
      
      // Update row styling
      document.querySelectorAll('.log-row').forEach((row, idx) => {
        if (selectAll) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });
    }

    // Toggle selection of individual log
    function toggleLogSelection(checkbox, index) {
      if (checkbox.checked) {
        selectedLogs.add(index);
        checkbox.parentElement.parentElement.classList.add('selected');
      } else {
        selectedLogs.delete(index);
        checkbox.parentElement.parentElement.classList.remove('selected');
      }
      
      // Update select all checkbox
      const selectAll = document.getElementById('selectAllLogs');
      selectAll.checked = selectedLogs.size === userSessions.length;
    }

    // Delete selected logs
    function deleteSelectedLogs() {
      if (selectedLogs.size === 0) {
        showCustomAlert("Please select at least one log to delete.");
        return;
      }
      
      showCustomConfirm(`Are you sure you want to delete ${selectedLogs.size} log(s)? This action cannot be undone.`, () => {
        // Delete selected logs (in reverse order to avoid index issues)
        const sortedIndexes = Array.from(selectedLogs).sort((a, b) => b - a);
        sortedIndexes.forEach(index => {
          userSessions.splice(index, 1);
        });
        
        // Clear selection
        selectedLogs.clear();
        document.getElementById('selectAllLogs').checked = false;
        
        // Update UI
        loadLogs();
        showCustomAlert(`${sortedIndexes.length} log(s) have been deleted successfully.`);
      });
    }

    // Export user logs as text file
    function exportUserLogs() {
      if (userSessions.length === 0) {
        showCustomAlert("No user logs available to export.");
        return;
      }
      
      let textContent = "USER LOGIN HISTORY REPORT\n";
      textContent += "Generated on: " + new Date().toLocaleString() + "\n";
      textContent += "Total records: " + userSessions.length + "\n\n";
      
      textContent += "USER SESSIONS:\n";
      textContent += "==============\n\n";
      
      userSessions.forEach((session, index) => {
        textContent += `RECORD ${index + 1}:\n`;
        textContent += `User: ${session.user}\n`;
        textContent += `Login Time: ${session.loginTime ? session.loginTime.toLocaleString() : "N/A"}\n`;
        textContent += `Logout Time: ${session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in"}\n`;
        textContent += `Duration: ${session.duration ? formatDuration(session.duration) : "N/A"}\n`;
        textContent += `Search Count: ${session.searchCount || 0}\n`;
        textContent += `Last Search: ${session.lastSearch || "No searches"}\n`;
        textContent += "----------------------------------------\n\n";
      });
      
      // Create download link
      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user_logs_report.txt';
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function validateName(name) {
      // Only allow letters and spaces, no numbers or special characters
      return /^[A-Za-z\s]+$/.test(name);
    }

    function setUserName() {
      const userName = document.getElementById("userName").value.trim();
      const nameError = document.getElementById("nameError");
      
      if (!userName) {
        nameError.textContent = "Please enter your name";
        nameError.classList.remove("hidden");
        return;
      }
      
      if (!validateName(userName)) {
        nameError.textContent = "Please enter a valid name (letters only, no numbers or special characters)";
        nameError.classList.remove("hidden");
        return;
      }
      
      nameError.classList.add("hidden");
      currentUserName = userName;
      currentUserLoginTime = new Date();
      userSearchCount = 0;
      userLastSearch = "";
      document.getElementById("userAuth").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      
      // Store user session
      userSessions.push({ user: userName, loginTime: currentUserLoginTime, logoutTime: null, searchCount: 0, lastSearch: "" });
      
      // Focus on search input for immediate use
      document.getElementById("searchInput").focus();
    }

    function logout() {
      if (currentUserName && currentUserLoginTime) {
        const logoutTime = new Date();
        const duration = Math.round((logoutTime - currentUserLoginTime) / 1000); // in seconds
        
        // Update the user session with logout time
        const currentSession = userSessions.find(session => session.user === currentUserName && session.logoutTime === null );
        if (currentSession) {
          currentSession.logoutTime = logoutTime;
          currentSession.duration = duration;
          currentSession.searchCount = userSearchCount;
          currentSession.lastSearch = userLastSearch;
        }
      }
      currentUserName = "";
      currentUserLoginTime = null;
      userSearchCount = 0;
      userLastSearch = "";
      document.getElementById("userAuth").classList.remove("hidden");
      document.getElementById("mainContent").classList.add("hidden");
      document.getElementById("adminLogin").classList.add("hidden");
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("userName").value = "";
      document.getElementById("userName").focus();
    }

    function toggleAdminLogin() {
      const adminLogin = document.getElementById("adminLogin");
      if (adminLogin.classList.contains("hidden")) {
        // Show admin login - don't hide other content
        adminLogin.classList.remove("hidden");
        // Clear previous inputs
        document.getElementById("adminUser").value = "";
        document.getElementById("adminPass").value = "";
        // Focus on username field
        document.getElementById("adminUser").focus();
      } else {
        // Hide admin login
        adminLogin.classList.add("hidden");
      }
    }

    function hideAdminPanel() {
      document.getElementById("adminPanel").classList.add("hidden");
      hideDeleteConfirmation();
    }

    async function loadAvailableFiles() {
      try {
        // Use GitHub API to list files in the repository
        const response = await fetch("https://api.github.com/repos/shakeelsnu/EmpData-by-Shakeel/contents/");
        const files = await response.json();
        // Filter for Excel files
        availableFiles = files.filter(f => f.name.endsWith(".xlsx"));
        // Update the file selection dropdown
        updateFileDropdown();
        return availableFiles;
      } catch (error) {
        console.error("Error loading available files:", error);
        document.getElementById("excelUploadDate").innerText = "❌ Failed to load file list";
        return [];
      }
    }

    // loadSelectedExcelFiles now accepts an optional parameter to preserve the column selection
    async function loadSelectedExcelFiles(lastSelectedColumn = null) {
      const fileSelect = document.getElementById("fileSelect");
      const selectedValue = fileSelect.value;
      if (!selectedValue) {
        return; // Don't show an alert, just don't load anything.
      }
      
      // If "All Files" is selected
      const loadAll = selectedValue === "all";
      const filesToLoad = loadAll ? availableFiles : availableFiles.filter(f => f.name === selectedValue);
      excelData = [];
      let loadedNames = [];
      
      for (const file of filesToLoad) {
        try {
          // Get the raw file content
          const rawUrl = `https://raw.githubusercontent.com/shakeelsnu/EmpData-by-Shakeel/main/${file.name}`;
          const res = await fetch(rawUrl);
          const arrayBuffer = await res.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          
          // Add filename to each row for tracking
          const rowsWithSource = rows.map(row => ({ ...row, __sourceFile: file.name }));
          excelData = excelData.concat(rowsWithSource);
          
          // Use nickname if available, otherwise use filename
          const displayName = fileNicknames[file.name] || file.name;
          loadedNames.push(displayName);
        } catch (err) {
          console.error("Failed loading:", file.name, err);
        }
      }
      
      document.getElementById("excelUploadDate").innerText = loadedNames.length > 0 ? loadedNames.join(", ") + " loaded at " + new Date().toLocaleString() : "❌ No Excel files found or selected";
      
      // After loading data, populate the column selector. Pass the last selected column.
      if (excelData.length > 0) {
        const headers = Object.keys(excelData[0]).filter(key => key !== '__sourceFile');
        currentHeaders = headers;
        visibleColumns = headers.slice(); // Set all columns to be visible by default
        populateColumnSelector(headers, lastSelectedColumn);
      } else {
        currentHeaders = [];
        visibleColumns = [];
        populateColumnSelector([]);
      }
    }

    // populateColumnSelector now accepts the last selected column as a parameter
    function populateColumnSelector(headers, lastSelectedColumn) {
      const columnSelect = document.getElementById("searchColumnSelect");
      columnSelect.innerHTML = ""; // Clear existing options
      
      if (headers.length > 0) {
        let hasNumericColumn = false;
        let defaultNumericColumn = null;
        
        // Find the first column with a numeric value
        for (const header of headers) {
          if (excelData.length > 0 && !isNaN(parseFloat(excelData[0][header]))) {
            defaultNumericColumn = header;
            hasNumericColumn = true;
            break;
          }
        }
        
        headers.forEach(header => {
          const option = document.createElement("option");
          option.value = header;
          option.textContent = header;
          
          // New logic to preserve the user's selection
          if (lastSelectedColumn && header === lastSelectedColumn) {
            option.selected = true;
          } else if (!lastSelectedColumn && hasNumericColumn && header === defaultNumericColumn) {
            // Fallback to default if no previous selection
            option.selected = true;
          }
          columnSelect.appendChild(option);
        });
      }
    }

    // New function to toggle visibility of the column selector
    function toggleColumnSearch() {
      const columnSelector = document.getElementById("columnSelector");
      const isChecked = document.getElementById("columnWiseSearchToggle").checked;
      if (isChecked) {
        columnSelector.classList.remove("hidden");
      } else {
        columnSelector.classList.add("hidden");
      }
    }

    async function getClientIP() {
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        return data.ip;
      } catch (e) {
        console.error("Could not fetch IP address:", e);
        return "N/A";
      }
    }
    
    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds} sec`;
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      if (minutes < 60) return `${minutes} min ${remainingSeconds} sec`;
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return `${hours} hr ${remainingMinutes} min`;
    }

    async function performSearch() {
      const searchText = document.getElementById("searchInput").value.trim();
      if (!searchText) {
        showCustomAlert("Please enter a search keyword.");
        return;
      }
      
      // No need to check for excelData.length === 0 here, as the file is already loaded
      // by the updateSelectedFilesDisplay function when the user selects a file.

      // Update search count and last search for the current user
      userSearchCount++;
      userLastSearch = searchText;
      
      const searchTerms = searchText.split(',').map(term => term.trim().toLowerCase());
      const searchType = document.getElementById('searchTypeSelect').value;
      const isColumnWise = document.getElementById('columnWiseSearchToggle').checked;
      const searchColumn = isColumnWise ? document.getElementById('searchColumnSelect').value : null;

      currentResults = [];
      const perTermMatches = {};
      const highlightMap = {};

      searchTerms.forEach((term, index) => {
        perTermMatches[term] = 0;
        highlightMap[term] = highlightColors[index % highlightColors.length];
      });

      const allHeaders = Object.keys(excelData[0]).filter(key => key !== '__sourceFile');
      currentHeaders = allHeaders;

      excelData.forEach(row => {
        let isMatch = false;
        let matchedTerms = new Set();
        const rowData = { ...row };

        // Determine which columns to search based on user's choice
        const searchHeaders = isColumnWise && searchColumn ? [searchColumn] : allHeaders;

        for (const header of searchHeaders) {
          const cellValue = String(row[header]).toLowerCase();
          searchTerms.forEach(term => {
            let match = false;
            switch (searchType) {
              case 'exact':
                match = cellValue === term;
                break;
              case 'startsWith':
                match = cellValue.startsWith(term);
                break;
              case 'endsWith':
                match = cellValue.endsWith(term);
                break;
              case 'contains':
              default:
                match = cellValue.includes(term);
                break;
            }
            if (match) {
              isMatch = true;
              matchedTerms.add(term);
              const highlightClass = highlightMap[term];
              // Use regex to wrap matched text
              const regex = new RegExp(`(${term})`, 'gi');
              const highlightedValue = String(row[header]).replace(regex, `<span class="${highlightClass}">$1</span>`);
              rowData[header] = highlightedValue;
            }
          });
        }

        if (isMatch) {
          currentResults.push(rowData);
          matchedTerms.forEach(term => {
            perTermMatches[term]++;
          });
        }
      });

      renderResults(currentResults, currentHeaders);
      
      document.getElementById("totalMatches").innerText = currentResults.length;
      document.getElementById("perTermMatches").innerText = "Matches per term: " + Object.entries(perTermMatches).map(([term, count]) => `${term} (${count})`).join(', ');
      document.getElementById("results").classList.remove("hidden");
    }

    function renderResults(results, headers) {
      const resultDiv = document.getElementById("resultText");
      if (results.length === 0) {
        resultDiv.innerHTML = "<p>No results found.</p>";
        return;
      }

      // Create a temporary table with the visible columns and data
      const table = document.createElement("table");
      table.id = "searchResultsTable";
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");
      
      // Filter headers based on visibleColumns
      const displayHeaders = headers.filter(header => visibleColumns.includes(header));
      
      // Create table header
      const headerRow = document.createElement("tr");
      displayHeaders.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        th.onclick = () => sortTable(header);
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Create table body
      results.forEach(row => {
        const tr = document.createElement("tr");
        displayHeaders.forEach(header => {
          const td = document.createElement("td");
          td.innerHTML = row[header] || ''; // Use innerHTML to render highlights
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      
      resultDiv.innerHTML = "";
      resultDiv.appendChild(table);
    }
    
    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      const table = document.getElementById('searchResultsTable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.rows);
      
      // Get the index of the column to sort
      const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
      const columnIndex = headers.indexOf(column);
      
      rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.toLowerCase();
        const bText = b.cells[columnIndex].textContent.toLowerCase();
        
        if (sortDirection === 'asc') {
          return aText.localeCompare(bText);
        } else {
          return bText.localeCompare(aText);
        }
      });
      
      // Clear and re-append sorted rows
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      rows.forEach(row => tbody.appendChild(row));
      
      // Update header indicators
      const allHeaders = table.querySelectorAll('th');
      allHeaders.forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.textContent === column) {
          th.classList.add(sortDirection);
        }
      });
    }

    function exportToExcel() {
      if (currentResults.length === 0) {
        showCustomAlert("No search results to export.");
        return;
      }

      // Create a temporary table with the visible columns and data, removing HTML
      const exportData = currentResults.map(row => {
        const newRow = {};
        visibleColumns.forEach(header => {
          const cellContent = row[header] || '';
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = cellContent;
          newRow[header] = tempDiv.textContent || tempDiv.innerText;
        });
        return newRow;
      });

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Search Results");
      XLSX.writeFile(workbook, "search_results.xlsx");
    }

    function exportToCsv() {
        if (currentResults.length === 0) {
            showCustomAlert("No search results to export.");
            return;
        }

        const data = currentResults.map(row => {
          const newRow = {};
          visibleColumns.forEach(header => {
            const cellContent = row[header] || '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cellContent;
            newRow[header] = tempDiv.textContent || tempDiv.innerText;
          });
          return newRow;
        });

        // Convert data to CSV string
        const headers = visibleColumns;
        let csvContent = headers.join(',') + '\n';
        data.forEach(row => {
            const rowValues = headers.map(header => {
                const value = row[header];
                // Handle commas and quotes in values
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            });
            csvContent += rowValues.join(',') + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'search_results.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function printResults() {
        if (currentResults.length === 0) {
          showCustomAlert("No search results to print.");
          return;
        }

        // Prepare a new table for printing that only contains visible columns
        const printTableContainer = document.getElementById("printTableContainer");
        printTableContainer.innerHTML = "";
        
        const printTable = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        // Create headers
        const headerRow = document.createElement("tr");
        visibleColumns.forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Create rows
        currentResults.forEach(row => {
            const tr = document.createElement("tr");
            visibleColumns.forEach(header => {
                const td = document.createElement("td");
                const cellContent = row[header] || '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cellContent;
                td.textContent = tempDiv.textContent || tempDiv.innerText;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        printTable.appendChild(thead);
        printTable.appendChild(tbody);
        printTableContainer.appendChild(printTable);

        // Populate print-only details
        document.getElementById("printQuery").textContent = document.getElementById("searchInput").value;
        document.getElementById("printMatches").textContent = document.getElementById("totalMatches").textContent;

        window.print();
    }
    
    // Custom Alert/Confirm functions
    function showCustomAlert(message) {
      const modal = document.createElement('div');
      modal.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; text-align: center;";
      modal.innerHTML = `
        <p>${message}</p>
        <button onclick="this.parentElement.remove()">OK</button>
      `;
      document.body.appendChild(modal);
    }

    function showCustomConfirm(message, onConfirm) {
      const modal = document.createElement('div');
      modal.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; text-align: center;";
      modal.innerHTML = `
        <p>${message}</p>
        <button onclick="this.parentElement.remove(); ${onConfirm.name}();">Yes</button>
        <button onclick="this.parentElement.remove()">No</button>
      `;
      document.body.appendChild(modal);
    }

    function showColumnCustomizer() {
      const customizer = document.getElementById('columnCustomizer');
      const checkboxesDiv = document.getElementById('columnCheckboxes');
      checkboxesDiv.innerHTML = '';
      
      if (currentHeaders.length === 0) {
        checkboxesDiv.innerHTML = "<p>No headers available. Perform a search first.</p>";
        customizer.classList.remove('hidden');
        return;
      }

      currentHeaders.forEach(header => {
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = header;
        input.checked = visibleColumns.includes(header);
        label.appendChild(input);
        label.append(header);
        checkboxesDiv.appendChild(label);
      });

      customizer.classList.remove('hidden');
    }

    function applyColumnVisibility() {
      const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
      visibleColumns = [];
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          visibleColumns.push(checkbox.value);
        }
      });
      
      if (visibleColumns.length === 0) {
        showCustomAlert("You must have at least one column visible.");
        // Revert to old state
        visibleColumns = currentHeaders;
        renderResults(currentResults, currentHeaders);
        document.getElementById('columnCustomizer').classList.add('hidden');
        return;
      }
      
      renderResults(currentResults, currentHeaders);
      document.getElementById('columnCustomizer').classList.add('hidden');
    }

    function showAllColumns() {
      visibleColumns = currentHeaders.slice();
      const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
      applyColumnVisibility();
    }
    
    // Render the log table in the admin panel
    function loadLogs() {
      const logTable = document.getElementById("logTable");
      logTable.innerHTML = "";
      
      userSessions.forEach((session, index) => {
        const loginTime = session.loginTime ? session.loginTime.toLocaleString() : "N/A";
        const logoutTime = session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in";
        const duration = session.duration ? formatDuration(session.duration) : "N/A";
        const searchCount = session.searchCount || 0;
        const lastSearch = session.lastSearch || "No searches";
        
        logTable.innerHTML += `
          <tr class="log-row">
            <td><input type="checkbox" class="log-checkbox" data-index="${index}" onchange="toggleLogSelection(this, ${index})"></td>
            <td>${session.user}</td>
            <td>${loginTime}</td>
            <td>${logoutTime}</td>
            <td>${duration}</td>
            <td>${searchCount}</td>
            <td>${lastSearch}</td>
          </tr>
        `;
      }); 
    }

    // Initialize the application
    window.onload = async function() { 
      document.getElementById("lastUpdated").innerText = new Date().toLocaleString(); 
      
      // Load file nicknames from localStorage
      loadFileNicknames();
      
      // Load available files from GitHub
      await loadAvailableFiles();
      
      // Add event listener for file selection change
      document.getElementById("fileSelect").addEventListener("change", updateSelectedFilesDisplay);
      
      // Add keyboard event listeners
      document.getElementById("userName").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") setUserName(); 
      });
      
      document.getElementById("searchInput").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") performSearch(); 
      }); 

      document.getElementById("adminPass").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") checkAdminLogin(); 
      }); 

      document.getElementById("deletePassword").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") deleteAllLogs(); 
      }); 
      
      // Initial call to load the first file when the page loads, if a file is selected by default
      if (document.getElementById("fileSelect").value !== "") {
          updateSelectedFilesDisplay();
      }
    };
  </script>
</body>
</html>
